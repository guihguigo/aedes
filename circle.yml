machine:
  timezone:
    America/Sao_Paulo
  node:
    version: 0.10.28
  services:
    - docker
  environment:
    NUM_VERSION: 1.0.$CIRCLE_BUILD_NUM
    BUILD_TAG: $CIRCLE_BRANCH-1.0.$CIRCLE_BUILD_NUM
  java:
    version: oraclejdk8
dependencies:
  cache_directories:
    - src/main/webapp/node_modules
    - src/main/webapp/bower_components
    - ~/.m2
    - ~/docker
  override:
    - mkdir -p ~/docker
    - if [[ ! -e ~/docker/tomcat_base.tar ]]; then docker pull "java:8" && docker save "java:8" > ~/docker/tomcat_base.tar; else docker load -i ~/docker/tomcat_base.tar; fi
    - npm install -g bower
    - npm install -g gulp
    - cd src/main/webapp && npm install
    - cd src/main/webapp && bower install
    - mvn --fail-never dependency:go-offline || true
test:
  override:
    - cd src/main/webapp && gulp clean
    - cd src/main/webapp && gulp build
    - ./generateVersion.sh
    #java
    - mvn versions:set -DnewVersion=$NUM_VERSION versions:commit
    - mvn clean org.jacoco:jacoco-maven-plugin:0.7.4.201502262128:prepare-agent install -U
    - cp ./target/aedes.jar docker_tomcat/aedes.jar
deployment:
  deploy:
    branch: deploy
    commands:
        - ./publicacao-deploy.sh
